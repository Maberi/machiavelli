{% extends "site_base.html" %}


{% load i18n %}
{% load machiavelli_tags %}
{% load avatar_tags %}

{% block head_title %}
{% if player %}
	{% if player.done %}
		[&bull;]
	{% else %}
		[ ]
	{% endif %}
{% endif %}
 {{ game.slug }}
{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{{ STATIC_URL }}machiavelli/css/game.css" />
{% endblock %}

{% block logo_link_image %}
<a href="{% url home %}"><img class="logo" src="{{ STATIC_URL }}machiavelli/img/game-logo.png" /></a>
{% endblock %}
{% block right_tabs %}{% endblock %}


{% block body %}
<div id="game_info">
<ul>
{% if player.contender.country %}
<li>
<img src="{{ STATIC_URL }}machiavelli/img/badge-{{ player.static_name }}.png" />
</li>
{% endif %}

</li>
<li id="cities_to_win">
{% if game.is_team_game %}
30*
{% else %}
{{ game.cities_to_win }}
{% endif %}
</li>
<li>{{ game.slug }}</li>
<li>{{ game.year|default_if_none:"" }} |
{{ game.get_season_display|default_if_none:"" }} |
{{ game.get_phase_display }}</li>
<li>
{% if player and game.slots == 0 %}
	{% if time_exceeded %}
	<span style="color: LightCoral">
	{{ game.next_phase_change|timeuntil }} 
	</span>
	{% else %}
	<span style="color: Green">
	{{ player.next_phase_change|timeuntil }}
	</span>
	{% endif %}
{% else %}
	{{ game.next_phase_change|timeuntil }}</li>
{% endif %}
</li>
{% if player %}
<li>
	{% if player.contender.country %}
		{{ player.contender.country }}
		{% if game.is_team_game %}
		({% trans "Team" %} {{ player.team.pk }})
		{% endif %}
	{% endif %}
</li>
{% else %}
<li>
		{% ifnotequal game.slots 0 %}
			<a href="{% url machiavelli.views.join_game game.pk %}">{% trans "Join game" %}</a>
		{% endifnotequal %}
</li>
{% endif %}
{% if rules %}
<li>
{% rule_icons game.configuration %}
</li>
{% endif %}

{% if ducats %}
<li>{% trans "Ducats" %}: {{ ducats }}</li>
{% endif %}

{% if player %}
{% if game.is_team_game %}
<li><a href="{% url team_messages game.slug %}"><img src="{{ STATIC_URL }}condottieri_messages/img/inbox-icon.png" title="{% trans "Team messages" %}" /></a></li>
{% else %}
<li>
	{% if player.unread_count > 0 %}
	<a href="{% url condottieri_messages_inbox game.slug %}"><img src="{{ STATIC_URL }}condottieri_messages/img/unread-icon.png" title="{% trans "You have new mail" %}" /></a>
	{% else %}
	<a href="{% url condottieri_messages_inbox game.slug %}"><img src="{{ STATIC_URL }}condottieri_messages/img/inbox-icon.png" title="{% trans "Inbox" %}" /></a>
	{% endif %}
	<a href="{% url condottieri_messages_outbox game.slug %}"><img src="{{ STATIC_URL }}condottieri_messages/img/outbox-icon.png" title="{% trans "Outbox" %}" /></a>
</li>
{% endif %}
{% endif %}
</ul>
</div>


<div class="col2">
	<div id="map" class="viewer">
	</div>
</div>

<div class="col3">

{% if game.slots == 0 %}
<div id="countries">
<table>
<thead>
	<tr>
	<th>{% trans "Country" %}</th>
	{% if show_users %}
	<th>{% trans "User" %}</th>
	{% endif %}
	<th><img src="{{ STATIC_URL }}machiavelli/img/city-icon-16.png" /></th>
	<th><img src="{{ STATIC_URL }}machiavelli/img/unit-icon-16.png" /></th>
	<th>{% trans "Actions" %}</th>
</thead>
	</tr>
	{% for p in player_list %}
	{% if p.user %}
	<tr class="{{ p.static_name }}">

		<td>
		{% if game.is_team_game %}
			[{{ p.team.pk }}]
		{% endif %} 
		{{ p.contender.country }} {% if p.conqueror %}({{ p.conqueror.contender.country }}){% endif %}
		{% if p.is_excommunicated %}
		<img src="{{ STATIC_URL }}machiavelli/img/excommunication-icon-16.png" />
		{% endif %}
		</td>

		{% if show_users %}
		<td><a href="{% url profile_detail username=p.user.username %}" title="{{ p.user.username }}">{% avatar p.user 20 %}</a></td>
		{% endif %}

		<td style="text-align: center">{{ p.number_of_cities }}</td>
		<td style="text-align: center">{{ p.placed_units_count }}</td>

		<td><!-- actions -->
{% if player %}
	{% ifnotequal game.phase 0 %}
	{% ifnotequal p player %}
	{% ifnotequal p.eliminated 1 %}
	<div>
	{% if not game.is_team_game %}
	<a href="{% url condottieri_messages_compose sender_id=player.id recipient_id=p.id %}"><img src="{{ STATIC_URL }}machiavelli/img/envelope.png" title="{% trans "Send message" %}" /></a>
	{% endif %}
	{% if game.configuration.finances %}
		<a href="{% url lend game.slug p.id %}"><img src="{{ STATIC_URL }}machiavelli/img/coin.png" title="{% trans "Give money" %}" /></a>
	{% endif %}
	{% if can_excommunicate %}
		{% ifnotequal p.is_excommunicated 1 %}
		<a href="{% url excommunicate game.slug p.id %}"><img src="{{ STATIC_URL }}machiavelli/img/excommunication-icon-16.png" title="{% trans "Excommunicate" %}" /></a>
		{% endifnotequal %}
	{% endif %}
	{% if can_forgive %}
		{% ifequal p.is_excommunicated 1 %}
		<a href="{% url forgive-excommunication game.slug p.id %}"><img src="{{ STATIC_URL }}machiavelli/img/forgive-icon-16.png" title="{% trans "Forgive" %}" /></a>
		{% endifequal %}
	{% endif %}
	</div>
	{% endifnotequal %}
	{% endifnotequal %}
	{% endifnotequal %}
{% endif %}
		</td><!-- actions -->

	</tr>
	{% endif %}
	{% endfor %}
</table>
</div>
{% endif %}

<div id="log">
<h3>{% trans "Campaign log" %}</h3>
<div class="menu">
<p><a href="{% url game-log game.slug %}">{% trans "See all" %}</a> | 
<a href="{% url turn-log-list game.slug %}">{% trans "Process" %}</a></p>
</div>
<ul>
{% for l in log %}
{{ l.color_output|safe }}
{% endfor %}
</ul>
</div>

</div>

<div class="clear"></div>

<div id="actions">
{% block actions %}{% endblock %}
</div>
<div id="mini_shoutbox">
<h2>{% trans "Journal" %}</h2>
<p>{{ excerpt|linebreaks }}</p>
<p><a href="{% url edit-journal game.slug %}">{% trans "Edit journal" %}</a></p>
{% if game.configuration.gossip %}
<h2>{% trans "Gossip" %}</h2>
<ul>
{% for w in whispers %}
{{ w.as_li|safe }}
{% endfor %}
</ul>
{% if whisper_form %}
<form action="{% url new-whisper game.slug %}" method="POST">
{% csrf_token %}
{{ whisper_form.text }}
<input type="submit" value="{% trans "Send" %}" />
</form>
{% endif %}
<p><a href="{% url whisper-list game.slug %}">{% trans "Show all" %}</a></p>
{% endif %}
</div>

{% endblock %}


{% block extra_body %}
{% block extra_game %}{% endblock %}
<script src="{{ STATIC_URL }}js/jquery.mousewheel.js" type="text/javascript"></script>
<script src="{{ STATIC_URL }}js/jquery.iviewer.min.js" type="text/javascript"></script>
<script type="text/javascript">
	$(function() {
		makeLayout();
	});

	function makeLayout() {
		var MEDIA_URL = "{{ MEDIA_URL }}";
		var viewer_opts = {
			src: MEDIA_URL + "maps/{{ map }}",
			ui_disabled: true,
			zoom: "fit",
			zoom_max: 100,
			zoom_min: 10,
			zoom_delta: 1.4,
			//zoom_base:
			update_on_resize: true
		};

		$("#map").iviewer(viewer_opts);
	}
</script>


{% endblock %}
